var express = require('express');
var http = require('http');
var mds = require('../lib/mds');

var app = express();
app.set('views', __dirname + '/views');
app.set('view engine', 'jade');
var server = http.createServer( app );

//mds.route( {
  //dir: __dirname + '/../doc',
  //url: '/*',
  //base: '',
  //redirect: true,
  //app: app,
  //view: 'root'
//} );

mds.route( {
  dir: __dirname + '/../doc/md',
  url: '/doc*',
  base: '/doc',
  redirect: true,
  app: app,
  view: 'doc'
} );

app.get( '/', function( req, res, next ) {
  res.redirect( '/doc' );
} );

app.all( '*', function( req, res, next ) {
  var headers = {};
  headers[ "Content-Type" ] = "application/json";
  var body = JSON.stringify(
    { error: "not_found", reason: "The page " + req.url + " was not found" } );
  headers[ "Content-Length" ] = Buffer.byteLength( body );
  res.writeHead( 404, headers );
  res.end( body );
} );

/**
 *  Start the server.
 */
server.listen(
  parseInt( process.env.npm_package_config_port ) );
